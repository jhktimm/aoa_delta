<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="200,1" id="srcline1">  1</a></span><span class="line"><span class="comment">% %% Facility</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% clear</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% warning('On')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% facility = 'XFEL.RF';</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% station = 'A19.L3';</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% module = 'M1';</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% cavity_all = {'C2'};</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,8" id="srcline8">  8</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% FS = doocsread([facility,'/LLRF.CONTROLLER/MAIN.M12.',station,'/FS']);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% F0 = doocsread([facility,'/LLRF.CONTROLLER/MAIN.M12.',station,'/F0']);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% % Static Values</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">% fs = FS.data*1e6;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% f0 = F0.data *1e6;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% Ts = 1/fs;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% %----------------- Time of Rise, Flattop and Decay ----------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% DELAY = doocsread([facility,'/LLRF.CONTROLLER/MAIN.M12.',station,'/PULSE_DELAY']);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% FILLING = doocsread([facility,'/LLRF.CONTROLLER/MAIN.M12.',station,'/PULSE_FILLING']);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% FLATTOP = doocsread([facility,'/LLRF.CONTROLLER/MAIN.M12.',station,'/PULSE_FLATTOP']);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% Rise = round(DELAY.data * fs *1e-6):round(DELAY.data * fs*1e-6+ FILLING.data*fs*1e-6);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% Flattop = Rise(end)+1 : Rise(end)+1+round(FLATTOP.data*fs*1e-6);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% Decay = Flattop(end)+1 : 2^(14);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% %% Get Data</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% % The Data used for all following algorithms are the complex signal</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,25" id="srcline25"> 25</a></span><span class="line"><span class="comment">% % representations of the forward, reflected and probe measurements of the</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">% % electromagnetic fields during each pulse.</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,27" id="srcline27"> 27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% % y_mC is the complex representation of the probe signal.</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,29" id="srcline29"> 29</a></span><span class="line"><span class="comment">% % u_mC is the complex represenation of the forward signal.</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">% % r_mC is the complex represnentation of the refelxted signal.</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,31" id="srcline31"> 31</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">% for k = 1:length(cavity_all)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,33" id="srcline33"> 33</a></span><span class="line"><span class="comment">%     cavity = cavity_all{k};</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%     [y_mC(:,k), u_mC(:,k), r_mC(:,k)] = f_getData(facility, station, module, cavity);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,36" id="srcline36"> 36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">%% Calibrate Data</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% Each pulse has to be calibrated such, that the sum of forwad and</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,39" id="srcline39"> 39</a></span><span class="line"><span class="comment">% refelcted is equal to the probe signal. abs(u_mC)+abs(r_mC) = abs(y_mC).</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,40" id="srcline40"> 40</a></span><span class="line"><span class="comment">% In general, the measurements of these signals are not calibrated. In</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,41" id="srcline41"> 41</a></span><span class="line"><span class="comment">% order to calibrate the forwad signal with respect to the probe, the</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% reflected signal is needed.</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,43" id="srcline43"> 43</a></span><span class="line"><span class="comment">% %--------------- Calibrated Forward and Probe------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,44" id="srcline44"> 44</a></span><span class="line"><span class="comment">% cal_coeff = zeros(4,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,45" id="srcline45"> 45</a></span><span class="line"><span class="comment">% coeff = [u_mC r_mC]\y_mC;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,46" id="srcline46"> 46</a></span><span class="line"><span class="comment">% if(max(abs(1-abs(coeff))&gt;0.05) || max(abs(180/pi*angle(coeff)) &gt; 5))</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">%     warning('Calibration required')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,48" id="srcline48"> 48</a></span><span class="line"><span class="comment">%     cal_coeff(:,k) = f_get_calCoeff(y_mC, u_mC, r_mC, Decay(1)+3000:Decay(end),1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,50" id="srcline50"> 50</a></span><span class="line"><span class="comment">% [u_mCal, r_mCal] = f_calibrateData(u_mC, r_mC, y_mC, cal_coeff);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,52" id="srcline52"> 52</a></span><span class="line"><span class="comment">% %------------Plot Before and After Calibration-----------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,53" id="srcline53"> 53</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% figure(22)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,55" id="srcline55"> 55</a></span><span class="line"><span class="comment">% subplot(2,1,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">% plot(abs(u_mC(:,1)+r_mC(:,1)),'r--')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,57" id="srcline57"> 57</a></span><span class="line"><span class="comment">% hold on</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">% plot(abs(y_mC(:,1)),'k--')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">% plot(abs(u_mC(:,1)),'g')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,60" id="srcline60"> 60</a></span><span class="line"><span class="comment">% plot(abs(r_mC(:,1)), 'b')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,61" id="srcline61"> 61</a></span><span class="line"><span class="comment">% legend('Virtual Probe', 'Probe', 'Forward', 'Reflected')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,62" id="srcline62"> 62</a></span><span class="line"><span class="comment">% ylabel('After Calbiration')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,64" id="srcline64"> 64</a></span><span class="line"><span class="comment">% subplot(2,1,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,65" id="srcline65"> 65</a></span><span class="line"><span class="comment">% plot(abs(u_mCal(:,1)+r_mCal(:,1)),'r--')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">% hold on</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,67" id="srcline67"> 67</a></span><span class="line"><span class="comment">% plot(abs(y_mC(:,1)),'k--')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% plot(abs(u_mCal(:,1)),'g')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,69" id="srcline69"> 69</a></span><span class="line"><span class="comment">% plot(abs(r_mCal(:,1)), 'b')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">% legend('Virtual Probe', 'Probe', 'Forward', 'Reflected')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">% ylabel('After Calbiration')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,72" id="srcline72"> 72</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">residual_ukf</span>, <span class="var type1" id="S3T1U4">residual_ukf_mean</span>, <span class="var type1" id="S4T2U5">residual_ukf_Variance</span>] = f_generate_online_UKF_residual(<span class="var type1" id="S5T4U8">Probe_Ampl</span>,<span class="var type1" id="S6T4U9">Probe_Phase</span>, <span class="var type1" id="S7T4U10">Forw_Ampl</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,73" id="srcline73"> 73</a></span><span class="line">    <span class="var type1" id="S8T4U11">Forw_Phase</span>, <span class="var type1" id="S9T4U12">Refl_Ampl</span>, <span class="var type1" id="S10T4U13">Refl_Probe</span>, <span class="var type1" id="S11T5U14">FS</span>, <span class="var type1" id="S12T5U15">F0</span>, <span class="var type1" id="S13T3U16">cal_coeff</span>, <span class="var type1" id="S14T6U17">tau_m</span>, <span class="var type1" id="S15T6U18">K_m</span>, <span class="var type1" id="S16T6U19">X0</span>, <span class="var type1" id="S17T5U20">DELAY</span>, <span class="var type1" id="S18T5U21">FILLING</span>, <span class="var type1" id="S19T5U22">FLATTOP</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="200,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">% inputs:</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">% Probe_Ampl: Amplitude of Probe measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">% Probe_Phase: Phase of Probe measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">% Forw_Ampl: Amplitude of Forward measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">% Forw_Phase: Phase of Forward measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,79" id="srcline79"> 79</a></span><span class="line"><span class="comment">% Refl_Ampl: Amplitude of Reflected measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">% Refl_Probe: Phase of Reflected measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">% fs: Sampling frequency, for online Data 9MHz, DAQ data 1MHz - can be read</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">% from DOOCS property</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">% f0: Resonance frequency, should be 1.3GHz - should be read</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,84" id="srcline84"> 84</a></span><span class="line"><span class="comment">% from DOOCS property</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,85" id="srcline85"> 85</a></span><span class="line"><span class="comment">% cal_coeff: coefficients necessary for the calibration of the signals,</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">% obtained from the function f_get_calCoeff</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">% Rise: Sample numbers that belong to the rise (filling) of the Pulse - should be read</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,88" id="srcline88"> 88</a></span><span class="line"><span class="comment">% from DOOCS property</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,89" id="srcline89"> 89</a></span><span class="line"><span class="comment">% Flattop: Samople numbers that belong to the flattop of the pulse - should be read</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,90" id="srcline90"> 90</a></span><span class="line"><span class="comment">% from DOOCS property</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,91" id="srcline91"> 91</a></span><span class="line"><span class="comment">% Decay: Sample numbers that belong to the decay of the pulse  - should be read</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,92" id="srcline92"> 92</a></span><span class="line"><span class="comment">% from DOOCS property</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,93" id="srcline93"> 93</a></span><span class="line"><span class="comment">%#cogegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,94" id="srcline94"> 94</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,95" id="srcline95"> 95</a></span><span class="line"><span class="mxinfo " id="T5:U19"><span class="var type1" id="S20T5U25">fs</span> = <span class="mxinfo " id="T5:U21"><span class="var type1" id="S11T5U27">FS</span>*<span class="mxinfo " id="T5:U23">1e6</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,96" id="srcline96"> 96</a></span><span class="line"><span class="mxinfo " id="T5:U24"><span class="var type1" id="S21T5U31">f0</span> = <span class="mxinfo " id="T5:U26"><span class="var type1" id="S12T5U33">F0</span>*<span class="mxinfo " id="T5:U28">1e6</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,97" id="srcline97"> 97</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,98" id="srcline98"> 98</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U29"><span class="var type1" id="S20T5U38">fs</span> ==<span class="mxinfo " id="T5:U31">1e6</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="200,99" id="srcline99"> 99</a></span><span class="line">    <span class="mxinfo " id="T21:U32"><span class="var type1" id="S22T21U42">Rise</span> = <span class="mxinfo " id="T21:U34"><span class="mxinfo " id="T5:U35">round(<span class="mxinfo " id="T5:U36"><span class="mxinfo " id="T5:U37"><span class="var type1" id="S17T5U48">DELAY</span> * <span class="var type1" id="S20T5U49">fs</span></span> *<span class="mxinfo " id="T5:U40">1e-6</span></span>)</span>:<span class="mxinfo " id="T5:U41">round(<span class="mxinfo " id="T5:U42"><span class="mxinfo " id="T5:U43"><span class="mxinfo " id="T5:U44"><span class="var type1" id="S17T5U56">DELAY</span> * <span class="var type1" id="S20T5U57">fs</span></span>*<span class="mxinfo " id="T5:U47">1e-6</span></span>+ <span class="mxinfo " id="T5:U48"><span class="mxinfo " id="T5:U49"><span class="var type1" id="S18T5U61">FILLING</span>*<span class="var type1" id="S20T5U62">fs</span></span>*<span class="mxinfo " id="T5:U52">1e-6</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,100" id="srcline100">100</a></span><span class="line">    <span class="mxinfo " id="T21:U53"><span class="var type1" id="S24T21U66">Flattop</span> = <span class="mxinfo " id="T21:U55"><span class="mxinfo " id="T5:U56"><span class="mxinfo " id="T5:U57"><span class="var type1" id="S22T21U70">Rise</span>(<span class="mxinfo " id="T5:U59">end</span>)</span>+<span class="mxinfo " id="T5:U60">1</span></span> : <span class="mxinfo " id="T5:U61"><span class="mxinfo " id="T5:U62"><span class="mxinfo " id="T5:U63"><span class="var type1" id="S22T21U77">Rise</span>(<span class="mxinfo " id="T5:U65">end</span>)</span>+<span class="mxinfo " id="T5:U66">1</span></span>+<span class="mxinfo " id="T5:U67">round(<span class="mxinfo " id="T5:U68"><span class="mxinfo " id="T5:U69"><span class="var type1" id="S19T5U85">FLATTOP</span>*<span class="var type1" id="S20T5U86">fs</span></span>*<span class="mxinfo " id="T5:U72">1e-6</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,101" id="srcline101">101</a></span><span class="line">    <span class="mxinfo " id="T21:U73"><span class="var type1" id="S26T21U90">Decay</span> = <span class="mxinfo " id="T21:U75"><span class="mxinfo " id="T5:U76"><span class="mxinfo " id="T5:U77"><span class="var type1" id="S24T21U94">Flattop</span>(<span class="mxinfo " id="T5:U79">end</span>)</span>+<span class="mxinfo " id="T5:U80">1</span></span> : round(2^(14)/9+1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,102" id="srcline102">102</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,103" id="srcline103">103</a></span><span class="line">    <span class="mxinfo " id="T21:U81"><span class="var type1" id="S22T21U111">Rise</span> = <span class="mxinfo " id="T21:U83"><span class="mxinfo " id="T5:U84">round(<span class="mxinfo " id="T5:U85"><span class="mxinfo " id="T5:U86"><span class="var type1" id="S17T5U117">DELAY</span> * <span class="var type1" id="S20T5U118">fs</span></span> *<span class="mxinfo " id="T5:U89">1e-6</span></span>)</span>:<span class="mxinfo " id="T5:U90">round(<span class="mxinfo " id="T5:U91"><span class="mxinfo " id="T5:U92"><span class="mxinfo " id="T5:U93"><span class="var type1" id="S17T5U125">DELAY</span> * <span class="var type1" id="S20T5U126">fs</span></span>*<span class="mxinfo " id="T5:U96">1e-6</span></span>+ <span class="mxinfo " id="T5:U97"><span class="mxinfo " id="T5:U98"><span class="var type1" id="S18T5U130">FILLING</span>*<span class="var type1" id="S20T5U131">fs</span></span>*<span class="mxinfo " id="T5:U101">1e-6</span></span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,104" id="srcline104">104</a></span><span class="line">    <span class="mxinfo " id="T21:U102"><span class="var type1" id="S24T21U135">Flattop</span> = <span class="mxinfo " id="T21:U104"><span class="mxinfo " id="T5:U105"><span class="mxinfo " id="T5:U106"><span class="var type1" id="S22T21U139">Rise</span>(<span class="mxinfo " id="T5:U108">end</span>)</span>+<span class="mxinfo " id="T5:U109">1</span></span> : <span class="mxinfo " id="T5:U110"><span class="mxinfo " id="T5:U111"><span class="mxinfo " id="T5:U112"><span class="var type1" id="S22T21U146">Rise</span>(<span class="mxinfo " id="T5:U114">end</span>)</span>+<span class="mxinfo " id="T5:U115">1</span></span>+<span class="mxinfo " id="T5:U116">round(<span class="mxinfo " id="T5:U117"><span class="mxinfo " id="T5:U118"><span class="var type1" id="S19T5U154">FLATTOP</span>*<span class="var type1" id="S20T5U155">fs</span></span>*<span class="mxinfo " id="T5:U121">1e-6</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo " id="T21:U122"><span class="var type1" id="S26T21U159">Decay</span> = <span class="mxinfo " id="T21:U124"><span class="mxinfo " id="T5:U125"><span class="mxinfo " id="T5:U126"><span class="var type1" id="S24T21U163">Flattop</span>(<span class="mxinfo " id="T5:U128">end</span>)</span>+<span class="mxinfo " id="T5:U129">1</span></span> : 2^(14)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,106" id="srcline106">106</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,107" id="srcline107">107</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,108" id="srcline108">108</a></span><span class="line"><span class="mxinfo " id="T29:U130"><span class="var type1" id="S27T29U173">y_mC</span> = complex(<span class="mxinfo " id="T29:U132"><span class="var type1" id="S5T4U177">Probe_Ampl</span>.*<span class="mxinfo " id="T29:U134">exp(<span class="mxinfo " id="T29:U135"><span class="mxinfo " id="T29:U136"><span class="mxinfo " id="T29:U137"><span class="mxinfo " id="T28:U138">1i</span>*<span class="var type1" id="S6T4U184">Probe_Phase</span></span>/180</span>*<span class="mxinfo " id="T5:U140">pi</span></span>)</span></span>)</span>; <span class="comment">% Complex Probe measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,109" id="srcline109">109</a></span><span class="line"><span class="mxinfo " id="T29:U141"><span class="var type1" id="S31T29U190">u_mC</span> = complex(<span class="mxinfo " id="T29:U143"><span class="var type1" id="S7T4U194">Forw_Ampl</span>.*<span class="mxinfo " id="T29:U145">exp(<span class="mxinfo " id="T29:U146"><span class="mxinfo " id="T29:U147"><span class="mxinfo " id="T29:U148"><span class="mxinfo " id="T28:U149">1i</span>*<span class="var type1" id="S8T4U201">Forw_Phase</span></span>/180</span>*<span class="mxinfo " id="T5:U151">pi</span></span>)</span></span>)</span>; <span class="comment">% Complex Forward measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,110" id="srcline110">110</a></span><span class="line"><span class="mxinfo " id="T29:U152"><span class="var type1" id="S32T29U207">r_mC</span> = complex(<span class="mxinfo " id="T29:U154"><span class="var type1" id="S9T4U211">Refl_Ampl</span>.*<span class="mxinfo " id="T29:U156">exp(<span class="mxinfo " id="T29:U157"><span class="mxinfo " id="T29:U158"><span class="mxinfo " id="T29:U159"><span class="mxinfo " id="T28:U160">1i</span>*<span class="var type1" id="S10T4U218">Refl_Probe</span></span>/180</span>*<span class="mxinfo " id="T5:U162">pi</span></span>)</span></span>)</span>; <span class="comment">% Reflected</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,111" id="srcline111">111</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,112" id="srcline112">112</a></span><span class="line"><span class="mxinfo " id="T5:U163"><span class="var type1" id="S33T5U224">QL</span>  = <span class="mxinfo " id="T5:U165"><span class="fcn" id="F511N8:B226">f_computeQL</span>(<span class="var type1" id="S26T21U227">Decay</span>, <span class="var type1" id="S27T29U228">y_mC</span>, <span class="var type1" id="S20T5U229">fs</span>, <span class="var type1" id="S21T5U230">f0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,113" id="srcline113">113</a></span><span class="line"><span class="comment">%% Online residual generation</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,114" id="srcline114">114</a></span><span class="line"><span class="comment">% tic</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,115" id="srcline115">115</a></span><span class="line"><span class="comment">% Y_MC = zeros(length(u_mC), 20);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,116" id="srcline116">116</a></span><span class="line"><span class="comment">% U_MC = zeros(length(u_mC), 20);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,117" id="srcline117">117</a></span><span class="line"><span class="comment">% R_MC = zeros(length(u_mC), 20);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,118" id="srcline118">118</a></span><span class="line"><span class="comment">% iterSwitch = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,119" id="srcline119">119</a></span><span class="line"><span class="comment">% iter = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,120" id="srcline120">120</a></span><span class="line"><span class="comment">% state_of_sys = cell(10,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,121" id="srcline121">121</a></span><span class="line"><span class="comment">% pNum = 1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,122" id="srcline122">122</a></span><span class="line"><span class="comment">% while(1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,123" id="srcline123">123</a></span><span class="line"><span class="comment">%     cavity = cavity_all{1};</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,124" id="srcline124">124</a></span><span class="line"><span class="comment">% u_mCal = zeros(length(u_mC),1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,125" id="srcline125">125</a></span><span class="line"><span class="comment">% r_mCal = zeros(length(u_mC),1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,126" id="srcline126">126</a></span><span class="line"><span class="comment">% [y_mC, u_mC, r_mC] = f_getData(facility, station, module, cavity);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,127" id="srcline127">127</a></span><span class="line"><span class="mxinfo " id="T95:U170"><span class="var type1" id="S35T95U233">initialStateGuess</span> = <span class="mxinfo " id="T95:U172">[<span class="mxinfo " id="T5:U173">0</span>;<span class="mxinfo " id="T5:U174">0</span>;<span class="var type1" id="S16T6U240">X0</span>]</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="200,128" id="srcline128">128</a></span><span class="line"><span class="mxinfo " id="T54:U176"><span class="var type1" id="S36T54U243">MeasNoise_mean</span> = <span class="mxinfo " id="T54:U178">[0;0]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,129" id="srcline129">129</a></span><span class="line"><span class="mxinfo " id="T79:U179"><span class="var type1" id="S37T79U251">MeasNoiseVar</span> = <span class="mxinfo " id="T79:U181">diag([0.01, 0.01])*1e-3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,130" id="srcline130">130</a></span><span class="line"><span class="mxinfo " id="T81:U182"><span class="var type1" id="S39T81U262">ProcessVar</span> = <span class="mxinfo " id="T81:U184">diag([0.01, 0.01, 0.01, 0.01, 0.01, 0.01].*1e-3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,131" id="srcline131">131</a></span><span class="line">[<span class="var type1" id="S40T29U278">u_mCal</span>, <span class="mxinfo " id="T29:U186">~</span>] = <span class="fcn" id="F538N6:B281">f_calibrateData</span>(<span class="var type1" id="S31T29U282">u_mC</span>, <span class="var type1" id="S32T29U283">r_mC</span>, <span class="var type1" id="S27T29U284">y_mC</span>, <span class="var type1" id="S13T3U285">cal_coeff</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="200,132" id="srcline132">132</a></span><span class="line"><span class="mxinfo " id="T85:U191"><span class="var type1" id="S42T85U288">y_Meas</span> = <span class="mxinfo " id="T85:U193">[<span class="mxinfo " id="T21:U194"><span class="mxinfo " id="T4:U195">real(<span class="var type1" id="S27T29U294">y_mC</span>)</span>.'</span>; <span class="mxinfo " id="T21:U197"><span class="mxinfo " id="T4:U198">imag(<span class="var type1" id="S27T29U299">y_mC</span>)</span>.'</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,133" id="srcline133">133</a></span><span class="line"><span class="mxinfo " id="T85:U200"><span class="var type1" id="S45T85U302">u_Meas</span> = <span class="mxinfo " id="T85:U202">[<span class="mxinfo " id="T21:U203"><span class="mxinfo " id="T4:U204">real(<span class="var type1" id="S40T29U308">u_mCal</span>)</span>.'</span>; <span class="mxinfo " id="T21:U206"><span class="mxinfo " id="T4:U207">imag(<span class="var type1" id="S40T29U313">u_mCal</span>)</span>.'</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,134" id="srcline134">134</a></span><span class="line"><span class="mxinfo " id="T2:U209"><span class="var type1" id="S4T2U316">residual_ukf_Variance</span> = <span class="mxinfo " id="T2:U211">zeros(<span class="mxinfo " id="T5:U212">2</span>,<span class="mxinfo " id="T5:U213">2</span>,<span class="mxinfo " id="T5:U214">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,135" id="srcline135">135</a></span><span class="line">[<span class="var type1" id="S47T85U325">res_full_mean</span>, <span class="mxinfo " id="T208:U216">~</span>, <span class="var type1" id="S48T85U327">res_full_xi</span>, <span class="var type1" id="S49T208U328">res_full_Info</span> ] = <span class="fcn" id="F1429N9:B330">f_compute_ukf_residual</span>(<span class="var type1" id="S35T95U331">initialStateGuess</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,136" id="srcline136">136</a></span><span class="line">    <span class="var type1" id="S36T54U332">MeasNoise_mean</span>, <span class="var type1" id="S37T79U333">MeasNoiseVar</span>, <span class="var type1" id="S39T81U334">ProcessVar</span>, <span class="var type1" id="S42T85U335">y_Meas</span>, <span class="var type1" id="S45T85U336">u_Meas</span>, <span class="var type1" id="S21T5U337">f0</span>, <span class="var type1" id="S20T5U338">fs</span>, <span class="var type1" id="S33T5U339">QL</span>, <span class="var type1" id="S14T6U340">tau_m</span>, <span class="var type1" id="S15T6U341">K_m</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="200,137" id="srcline137">137</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,138" id="srcline138">138</a></span><span class="line"><span class="comment">% figure(98)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,139" id="srcline139">139</a></span><span class="line"><span class="comment">% plot(res_full_mean(1,1:9:end),'k.', 'MarkerSize', 8)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,140" id="srcline140">140</a></span><span class="line"><span class="comment">% hold on</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,141" id="srcline141">141</a></span><span class="line"><span class="comment">% plot(res_full_mean(2,1:9:end),'g.', 'MarkerSize', 8)</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,142" id="srcline142">142</a></span><span class="line"><span class="comment">% xlabel('Samples')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,143" id="srcline143">143</a></span><span class="line"><span class="comment">% ylabel('Residual')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,144" id="srcline144">144</a></span><span class="line"><span class="comment">% legend('I', 'Q')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,145" id="srcline145">145</a></span><span class="line"><span class="comment">% axis tight</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,146" id="srcline146">146</a></span><span class="line"><span class="comment">% ylim([-0.025,0.025])</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,147" id="srcline147">147</a></span><span class="line"><span class="comment">% ax= gca;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,148" id="srcline148">148</a></span><span class="line"><span class="comment">% ax.FontName = 'Calibri';</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,149" id="srcline149">149</a></span><span class="line"><span class="comment">% ax.FontSize = 20;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,150" id="srcline150">150</a></span><span class="line"><span class="comment">% set(gcf,'Color', 'w')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,151" id="srcline151">151</a></span><span class="line"><span class="comment">% Arithmetic mean of the mean </span></span></span>
<span class="srcline"><span class="lineno"><a href="200,152" id="srcline152">152</a></span><span class="line"><span class="mxinfo " id="T1:U230"><span class="var type1" id="S2T1U344">residual_ukf</span> = <span class="mxinfo " id="T1:U232">[<span class="mxinfo " id="T54:U233">mean(<span class="mxinfo " id="T85:U234"><span class="var type1" id="S47T85U350">res_full_mean</span>(<span class="mxinfo " id="T22:U236">:</span>,<span class="var type1" id="S22T21U352">Rise</span>)</span>,2)</span>,<span class="mxinfo " id="T54:U238">mean(<span class="mxinfo " id="T85:U239"><span class="var type1" id="S47T85U357">res_full_mean</span>(<span class="mxinfo " id="T22:U241">:</span>,<span class="var type1" id="S24T21U359">Flattop</span>)</span>,2)</span>,<span class="mxinfo " id="T54:U243">mean(<span class="mxinfo " id="T85:U244"><span class="var type1" id="S47T85U364">res_full_mean</span>(<span class="mxinfo " id="T22:U246">:</span>,<span class="var type1" id="S26T21U366">Decay</span>)</span>,2)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,153" id="srcline153">153</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,154" id="srcline154">154</a></span><span class="line"><span class="comment">% Equality Node: Taking the variance into consideration</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,155" id="srcline155">155</a></span><span class="line"><span class="mxinfo " id="T79:U248"><span class="mxinfo " id="T79:U249"><span class="var type1" id="S4T2U371">residual_ukf_Variance</span>(<span class="mxinfo " id="T22:U251">:</span>,<span class="mxinfo " id="T22:U252">:</span>,<span class="mxinfo " id="T5:U253">1</span>)</span> = <span class="mxinfo " id="T79:U254"><span class="mxinfo " id="T79:U255">[reshape(<span class="mxinfo " id="T211:U256">sum(<span class="mxinfo " id="T208:U257"><span class="var type1" id="S49T208U383">res_full_Info</span>(<span class="var type1" id="S22T21U384">Rise</span>,<span class="mxinfo " id="T22:U260">:</span>,<span class="mxinfo " id="T22:U261">:</span>)</span>)</span>,[2,2])]</span>\<span class="mxinfo " id="T79:U262">eye(2,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,156" id="srcline156">156</a></span><span class="line"><span class="mxinfo " id="T79:U263"><span class="mxinfo " id="T79:U264"><span class="var type1" id="S4T2U398">residual_ukf_Variance</span>(<span class="mxinfo " id="T22:U266">:</span>,<span class="mxinfo " id="T22:U267">:</span>,<span class="mxinfo " id="T5:U268">2</span>)</span> = <span class="mxinfo " id="T79:U269"><span class="mxinfo " id="T79:U270">[reshape(<span class="mxinfo " id="T211:U271">sum(<span class="mxinfo " id="T208:U272"><span class="var type1" id="S49T208U410">res_full_Info</span>(<span class="var type1" id="S24T21U411">Flattop</span>,<span class="mxinfo " id="T22:U275">:</span>,<span class="mxinfo " id="T22:U276">:</span>)</span>)</span>,[2,2])]</span>\<span class="mxinfo " id="T79:U277">eye(2,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,157" id="srcline157">157</a></span><span class="line"><span class="mxinfo " id="T79:U278"><span class="mxinfo " id="T79:U279"><span class="var type1" id="S4T2U425">residual_ukf_Variance</span>(<span class="mxinfo " id="T22:U281">:</span>,<span class="mxinfo " id="T22:U282">:</span>,<span class="mxinfo " id="T5:U283">3</span>)</span> = <span class="mxinfo " id="T79:U284"><span class="mxinfo " id="T79:U285">[reshape(<span class="mxinfo " id="T211:U286">sum(<span class="mxinfo " id="T208:U287"><span class="var type1" id="S49T208U437">res_full_Info</span>(<span class="var type1" id="S26T21U438">Decay</span>,<span class="mxinfo " id="T22:U290">:</span>,<span class="mxinfo " id="T22:U291">:</span>)</span>)</span>,[2,2])]</span>\<span class="mxinfo " id="T79:U292">eye(2,2)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,158" id="srcline158">158</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,159" id="srcline159">159</a></span><span class="line"><span class="mxinfo " id="T1:U293"><span class="var type1" id="S3T1U451">residual_ukf_mean</span> = <span class="mxinfo " id="T1:U295">[ <span class="mxinfo " id="T54:U296"><span class="mxinfo " id="T79:U297"><span class="mxinfo " id="T79:U298">[reshape(<span class="mxinfo " id="T211:U299">sum(<span class="mxinfo " id="T208:U300"><span class="var type1" id="S49T208U463">res_full_Info</span>(<span class="var type1" id="S22T21U464">Rise</span>,<span class="mxinfo " id="T22:U303">:</span>,<span class="mxinfo " id="T22:U304">:</span>)</span>)</span>,[2,2])]</span>\<span class="mxinfo " id="T79:U305">eye(2,2)</span></span> * <span class="mxinfo " id="T54:U306">sum(<span class="mxinfo " id="T85:U307"><span class="var type1" id="S48T85U478">res_full_xi</span>(<span class="mxinfo " id="T22:U309">:</span>,<span class="var type1" id="S22T21U480">Rise</span>)</span>,2)</span></span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,160" id="srcline160">160</a></span><span class="line">   <span class="mxinfo " id="T54:U311"><span class="mxinfo " id="T79:U312"><span class="mxinfo " id="T79:U313">[reshape(<span class="mxinfo " id="T211:U314">sum(<span class="mxinfo " id="T208:U315"><span class="var type1" id="S49T208U491">res_full_Info</span>(<span class="var type1" id="S24T21U492">Flattop</span>,<span class="mxinfo " id="T22:U318">:</span>,<span class="mxinfo " id="T22:U319">:</span>)</span>)</span>,[2,2])]</span>\<span class="mxinfo " id="T79:U320">eye(2,2)</span></span>*<span class="mxinfo " id="T54:U321">sum(<span class="mxinfo " id="T85:U322"><span class="var type1" id="S48T85U506">res_full_xi</span>(<span class="mxinfo " id="T22:U324">:</span>,<span class="var type1" id="S24T21U508">Flattop</span>)</span>,2)</span></span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,161" id="srcline161">161</a></span><span class="line">   <span class="mxinfo " id="T54:U326"><span class="mxinfo " id="T79:U327"><span class="mxinfo " id="T79:U328">[reshape(<span class="mxinfo " id="T211:U329">sum(<span class="mxinfo " id="T208:U330"><span class="var type1" id="S49T208U519">res_full_Info</span>(<span class="var type1" id="S26T21U520">Decay</span>,<span class="mxinfo " id="T22:U333">:</span>,<span class="mxinfo " id="T22:U334">:</span>)</span>)</span>,[2,2])]</span>\<span class="mxinfo " id="T79:U335">eye(2,2)</span></span>*<span class="mxinfo " id="T54:U336">sum(<span class="mxinfo " id="T85:U337"><span class="var type1" id="S48T85U534">res_full_xi</span>(<span class="mxinfo " id="T22:U339">:</span>,<span class="var type1" id="S26T21U536">Decay</span>)</span>,2)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="200,162" id="srcline162">162</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="200,163" id="srcline163">163</a></span><span class="line"><span class="comment">%     Y_MC(:, 2:end) = Y_MC(:, 1:end-1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,164" id="srcline164">164</a></span><span class="line"><span class="comment">%     Y_MC(:, 1) = y_mC;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,165" id="srcline165">165</a></span><span class="line"><span class="comment">%     U_MC(:, 2:end) = U_MC(:, 1:end-1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,166" id="srcline166">166</a></span><span class="line"><span class="comment">%     U_MC(:, 1) = u_mCal;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,167" id="srcline167">167</a></span><span class="line"><span class="comment">%     R_MC(:, 2:end) = R_MC(:, 1:end-1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,168" id="srcline168">168</a></span><span class="line"><span class="comment">%     R_MC(:, 1) = r_mCal;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,169" id="srcline169">169</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,170" id="srcline170">170</a></span><span class="line"><span class="comment">%     if abs(residual1(pNum,1)) &gt; 3e-6 || abs(residual1(pNum,2)) &gt; 3e-6 || abs(residual1(pNum,3)) &gt; 4e-6</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,171" id="srcline171">171</a></span><span class="line"><span class="comment">%         state_of_sys(2:end) = state_of_sys(1:end-1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,172" id="srcline172">172</a></span><span class="line"><span class="comment">%         state_of_sys(1) = {'fault'};</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,173" id="srcline173">173</a></span><span class="line"><span class="comment">%         if iterSwitch == 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,174" id="srcline174">174</a></span><span class="line"><span class="comment">%         iterSwitch = 1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,175" id="srcline175">175</a></span><span class="line"><span class="comment">%         iter = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,176" id="srcline176">176</a></span><span class="line"><span class="comment">%         pNum</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,177" id="srcline177">177</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,178" id="srcline178">178</a></span><span class="line"><span class="comment">%     else</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,179" id="srcline179">179</a></span><span class="line"><span class="comment">%         state_of_sys(2:end) = state_of_sys(1:end-1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,180" id="srcline180">180</a></span><span class="line"><span class="comment">%         state_of_sys(1) = {'nominal'};</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,181" id="srcline181">181</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,182" id="srcline182">182</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,183" id="srcline183">183</a></span><span class="line"><span class="comment">%     if iterSwitch == 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,184" id="srcline184">184</a></span><span class="line"><span class="comment">%         iter = iter +1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,185" id="srcline185">185</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,186" id="srcline186">186</a></span><span class="line"><span class="comment">%     if iter == 5</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,187" id="srcline187">187</a></span><span class="line"><span class="comment">%         save('fault_data.mat','U_MC','Y_MC','R_MC')</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,188" id="srcline188">188</a></span><span class="line"><span class="comment">%         iterSwitch = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,189" id="srcline189">189</a></span><span class="line"><span class="comment">%         iter = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,190" id="srcline190">190</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,191" id="srcline191">191</a></span><span class="line"><span class="comment">%     pNum = pNum +1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,192" id="srcline192">192</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="200,193" id="srcline193">193</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="200,194" id="srcline194">194</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
